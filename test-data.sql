--organization creators
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('2a231114-fd02-4e8c-bc9e-95fd5c132b96','adasdfadsf','adfa','poinc','asdfoij@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.618178-07','2022-06-07 11:21:11.618178-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('58dc4051-3acb-4c61-88b7-2cbcca459abb','balkdsfhha','boiuadsaf','oiubab','pubwe@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.67236-07','2022-06-07 11:21:11.67236-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('91a0ea14-4c44-4854-9438-af823bba2617','weuhiouasug','cdapoifha','sapdoifhhiu','dfasiua@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.723185-07','2022-06-07 11:21:11.723185-07');


--organization users
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('a282a39f-cc9a-461c-94aa-a88fdbae651c','tukdfghxdg','hqfwrqaF','vqweasfdSF','vqweasfdSF@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.031851-07','2022-06-07 11:21:12.031851-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('c16a6f4a-cae3-4125-876c-741d858d0cbc','awere','dadfdffa','dafadfwe','afadfwe@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.827312-07','2022-06-07 11:21:11.827312-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('da01effd-22af-4eda-8fcc-c0ace2dbec59','aktukghgfhgasdfadsf','eqrtawefased','qrgwrggw','aqrgwrggw@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.878483-07','2022-06-07 11:21:11.878483-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('e106df5a-30f4-44a4-8f17-1c57e145f78f','adasdfaerertadfadsfadsf','fabgsfteradfa','poqeqerinc','poqeqerinc@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.9297-07','2022-06-07 11:21:11.9297-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('d7ee5cda-570b-4633-b7e4-253fe52fe5d0','gqw43r5adfgaf','gadgrwtaewtfa','agretaewrQ2','agretaewrQ2@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.981086-07','2022-06-07 11:21:11.981086-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('aa4a7222-6962-44ad-ad90-301226e31128','qewazdsyzserytz','iawetataet','gqgeqwarfe','gqgeqwarfe@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.08442-07','2022-06-07 11:21:12.08442-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('88404e06-91d2-465d-ae41-d1a7d4b4abc9','ukfkjrtyj56','jqaytagzasg','graasgsafaA','graasgsafaA@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.136411-07','2022-06-07 11:21:12.136411-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('e6fe85c3-1113-4614-b73b-8f36f67e19f9','mjmjyffyumdty','kgfsfsdf','gwrsegrs','gwrsegrs@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.188812-07','2022-06-07 11:21:12.188812-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('2d7be3f4-f104-482e-8a47-b2b9e811ccd8','xvghkjhvjfh','lWAReefDSDSF','aeweafgGDSGD','aeweafgGDSGD@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.243045-07','2022-06-07 11:21:12.243045-07');

--organisations
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('15e27b73-d6a8-458a-9ec3-df22ef572a92','dpinen','anfpannw','58dc4051-3acb-4c61-88b7-2cbcca459abb',NULL,'PERSONAL',50,'mgpoien@me.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.779358-07','2022-06-07 11:31:29.779358-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('8636aaaa-f6e7-4e85-8a23-f8c8003bf805','adsfadf','fhapdfion','2a231114-fd02-4e8c-bc9e-95fd5c132b96',NULL,'TEAM',8,'asdfa3@gmail.com',NULL,NULL,'FREE',NULL,'2022-06-07 11:31:29.723805-07','2022-06-07 11:31:29.723805-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('8e8dae38-12c0-4b9e-bcae-ce7552b9478b','dsfjiepoine','djjdott','91a0ea14-4c44-4854-9438-af823bba2617',NULL,'TEAM',15050,'aiebiubf@aseeb.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.830707-07','2022-06-07 11:31:29.830707-07');

INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('25e27b73-d6a8-458a-9ec3-df22ef572a92','dpinen','anfpannw','58dc4051-3acb-4c61-88b7-2cbcca459abb',NULL,'PERSONAL',50,'mgpoien@me.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.779358-07','2022-06-07 11:31:29.779358-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('3636aaaa-f6e7-4e85-8a23-f8c8003bf805','adsfadf','fhapdfion','2a231114-fd02-4e8c-bc9e-95fd5c132b96',NULL,'TEAM',8,'asdfa3@gmail.com',NULL,NULL,'FREE',NULL,'2022-06-07 11:31:29.723805-07','2022-06-07 11:31:29.723805-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('4e8dae38-12c0-4b9e-bcae-ce7552b9478b','dsfjiepoine','djjdott','91a0ea14-4c44-4854-9438-af823bba2617',NULL,'TEAM',15050,'aiebiubf@aseeb.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.830707-07','2022-06-07 11:31:29.830707-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('55e27b73-d6a8-458a-9ec3-df22ef572a92','dpinen','anfpannw','58dc4051-3acb-4c61-88b7-2cbcca459abb',NULL,'PERSONAL',50,'mgpoien@me.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.779358-07','2022-06-07 11:31:29.779358-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('6636aaaa-f6e7-4e85-8a23-f8c8003bf805','adsfadf','fhapdfion','2a231114-fd02-4e8c-bc9e-95fd5c132b96',NULL,'TEAM',8,'asdfa3@gmail.com',NULL,NULL,'FREE',NULL,'2022-06-07 11:31:29.723805-07','2022-06-07 11:31:29.723805-07');
INSERT INTO public.organisations (id,"name",subdomain,creator,allowlisted_domains,workspace_type,employee_count,billing_email,profile_image_id,preferences,pricing_plan,metadata,created_at,updated_at) VALUES ('7e8dae38-12c0-4b9e-bcae-ce7552b9478b','dsfjiepoine','djjdott','91a0ea14-4c44-4854-9438-af823bba2617',NULL,'TEAM',15050,'aiebiubf@aseeb.com',NULL,NULL,'PAID',NULL,'2022-06-07 11:31:29.830707-07','2022-06-07 11:31:29.830707-07');


--organisation_users
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('018c1cf6-40ce-4e78-9958-052fd41693bb','15e27b73-d6a8-458a-9ec3-df22ef572a92','e106df5a-30f4-44a4-8f17-1c57e145f78f','ADMIN',NULL,'2022-06-07 11:36:03.049218-07','2022-06-07 11:36:03.049218-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('26c38fcb-7a62-4f65-b4a5-6cb414224034','8e8dae38-12c0-4b9e-bcae-ce7552b9478b','2d7be3f4-f104-482e-8a47-b2b9e811ccd8','ADMIN',NULL,'2022-06-07 11:36:03.36626-07','2022-06-07 11:36:03.36626-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('3c6bacd5-cf8e-4de1-b631-872f4b54e4c2','8636aaaa-f6e7-4e85-8a23-f8c8003bf805','d7ee5cda-570b-4633-b7e4-253fe52fe5d0','MEMBER',NULL,'2022-06-07 11:36:03.101087-07','2022-06-07 11:36:03.101087-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('5b3fe9d5-fa88-4e22-97ed-4232a7d99066','15e27b73-d6a8-458a-9ec3-df22ef572a92','c16a6f4a-cae3-4125-876c-741d858d0cbc','MEMBER',NULL,'2022-06-07 11:36:02.941536-07','2022-06-07 11:36:02.941536-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('795666da-c566-443b-8e3f-4dbc8565443b','8e8dae38-12c0-4b9e-bcae-ce7552b9478b','88404e06-91d2-465d-ae41-d1a7d4b4abc9','MEMBER',NULL,'2022-06-07 11:36:03.261046-07','2022-06-07 11:36:03.261046-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('85001463-f5fb-4c90-a082-debf44d657aa','8636aaaa-f6e7-4e85-8a23-f8c8003bf805','a282a39f-cc9a-461c-94aa-a88fdbae651c','CREATOR',NULL,'2022-06-07 11:36:03.154909-07','2022-06-07 11:36:03.154909-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('a8d8baa5-d803-4cd7-896d-db2f9415329b','8e8dae38-12c0-4b9e-bcae-ce7552b9478b','e6fe85c3-1113-4614-b73b-8f36f67e19f9','CREATOR',NULL,'2022-06-07 11:36:03.312501-07','2022-06-07 11:36:03.312501-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('ab6b84eb-b252-483f-a682-ae7c10573bed','15e27b73-d6a8-458a-9ec3-df22ef572a92','da01effd-22af-4eda-8fcc-c0ace2dbec59','CREATOR',NULL,'2022-06-07 11:36:02.996333-07','2022-06-07 11:36:02.996333-07');
INSERT INTO public.organisation_users (id,org_id,user_id,"role",metadata,created_at,updated_at) VALUES ('c0589524-a632-401a-a255-12c5bf25261e','8636aaaa-f6e7-4e85-8a23-f8c8003bf805','aa4a7222-6962-44ad-ad90-301226e31128','ADMIN',NULL,'2022-06-07 11:36:03.206687-07','2022-06-07 11:36:03.206687-07');


-- first, let's create a record in our users (RBR) table
explain INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('2a231114-fd02-4e8c-bc9e-95fd5c132b96','adasdfadsf','adfa','poinc','asdfoij@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.618178-07','2022-06-07 11:21:11.618178-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('2a231114-fd02-4e8c-bc9e-95fd5c132b96','adasdfadsf','adfa','poinc','asdfoij@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.618178-07','2022-06-07 11:21:11.618178-07');
741ms

-- in which range, lease_holder and replicas is the data I just inserted located?
    select range_id, lease_holder, replicas from [show range from table users for row('aws-us-west-2','2a231114-fd02-4e8c-bc9e-95fd5c132b96')];

-- we may need to look at the zone for the 
show partitions from table users;

-- now, insert a row into the child table "organisations"
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('a282a39f-cc9a-461c-94aa-a88fdbae651c','tukdfghxdg','hqfwrqaF','vqweasfdSF','vqweasfdSF@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.031851-07','2022-06-07 11:21:12.031851-07');
584ms

-- in which range, lease_holder and replicas is the data I just inserted located?
select range_id, lease_holder, replicas from [show range from table organisations for row('aws-us-west-2','2a231114-fd02-4e8c-bc9e-95fd5c132b96')];

-- here's the problem
explain INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('a282a39f-cc9a-461c-94aa-a88fdbae651c','tukdfghxdg','hqfwrqaF','vqweasfdSF','vqweasfdSF@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:12.031851-07','2022-06-07 11:21:12.031851-07');
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  distribution: local
  vectorized: true

  • root
  │
  ├── • insert
  │   │ into: users(id, auth_id, first_name, last_name, email, profile_picture_id, default_picture, preferences, metadata, created_at, updated_at, crdb_region)
  │   │
  │   └── • values
  │         size: 13 columns, 1 row
  │
  ├── • constraint-check
  │   │
  │   └── • error if rows
  │       │
  │       └── • cross join
  │           │ estimated row count: 0
  │           │
  │           ├── • values
  │           │     size: 1 column, 1 row
  │           │
  │           └── • scan
  │                 estimated row count: 0 (<0.01% of the table; stats collected 5 minutes ago)
  │                 table: users@users_pkey
  │                 spans: [/'aws-ap-southeast-1'/'a282a39f-cc9a-461c-94aa-a88fdbae651c' - /'aws-ap-southeast-1'/'a282a39f-cc9a-461c-94aa-a88fdbae651c'] [/'aws-us-east-1'/'a282a39f-cc9a-461c-94aa-a88fdbae651c' - /'aws-us-east-1'/'a282a39f-cc9a-461c-94aa-a88fdbae651c']
  │                 limit: 1
  │
  ├── • constraint-check
  │   │
  │   └── • error if rows
  │       │
  │       └── • cross join (semi)
  │           │ estimated row count: 1
  │           │
  │           ├── • values
  │           │     size: 1 column, 1 row
  │           │
  │           └── • filter
  │               │ estimated row count: 1
  │               │ filter: (id != 'a282a39f-cc9a-461c-94aa-a88fdbae651c') OR (crdb_region != 'aws-us-west-2')
  │               │
  │               └── • union all
  │                   │ estimated row count: 1
  │                   │ limit: 3
  │                   │
  │                   ├── • scan
  │                   │     estimated row count: 1 (50% of the table; stats collected 5 minutes ago)
  │                   │     table: users@users_auth_id_key
  │                   │     spans: [/'aws-us-west-2'/'tukdfghxdg' - /'aws-us-west-2'/'tukdfghxdg']
  │                   │
  │                   └── • scan
  │                         estimated row count: 1 (50% of the table; stats collected 5 minutes ago)
  │                         table: users@users_auth_id_key
  │                         spans: [/'aws-ap-southeast-1'/'tukdfghxdg' - /'aws-ap-southeast-1'/'tukdfghxdg'] [/'aws-us-east-1'/'tukdfghxdg' - /'aws-us-east-1'/'tukdfghxdg']
  │
  └── • constraint-check
      │
      └── • error if rows
          │
          └── • cross join (semi)
              │ estimated row count: 1
              │
              ├── • values
              │     size: 1 column, 1 row
              │
              └── • filter
                  │ estimated row count: 1
                  │ filter: (id != 'a282a39f-cc9a-461c-94aa-a88fdbae651c') OR (crdb_region != 'aws-us-west-2')
                  │
                  └── • union all
                      │ estimated row count: 1
                      │ limit: 3
                      │
                      ├── • scan
                      │     estimated row count: 1 (50% of the table; stats collected 5 minutes ago)
                      │     table: users@users_email_key
                      │     spans: [/'aws-us-west-2'/'vqweasfdSF@gmail.com' - /'aws-us-west-2'/'vqweasfdSF@gmail.com']
                      │
                      └── • scan
                            estimated row count: 1 (50% of the table; stats collected 5 minutes ago)
                            table: users@users_email_key
                            spans: [/'aws-ap-southeast-1'/'vqweasfdSF@gmail.com' - /'aws-ap-southeast-1'/'vqweasfdSF@gmail.com'] [/'aws-us-east-1'/'vqweasfdSF@gmail.com' - /'aws-us-east-1'/'vqweasfdSF@gmail.com']
(82 rows)



set cluster setting sql.defaults.experimental_enable_unique_without_index_constraints.enabled = True;
SET experimental_enable_unique_without_index_constraints = true;
alter table users add constraint xxxxx unique without index (id, crdb_region);

explain INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('58dc4051-3acb-4c61-88b7-2cbcca459abb','balkdsfhha','boiuadsaf','oiubab','pubwe@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.67236-07','2022-06-07 11:21:11.67236-07');
INSERT INTO public."users" (id,auth_id,first_name,last_name,email,profile_picture_id,default_picture,preferences,metadata,created_at,updated_at) VALUES ('58dc4051-3acb-4c61-88b7-2cbcca459abb','balkdsfhha','boiuadsaf','oiubab','pubwe@gmail.com',NULL,NULL,NULL,NULL,'2022-06-07 11:21:11.67236-07','2022-06-07 11:21:11.67236-07');
242ms




